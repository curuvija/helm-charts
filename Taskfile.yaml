version: 3

vars:
  QE_PATH: charts/query-exporter

tasks:
  polaris:
    cmds:
      - polaris audit --helm-chart {{.CLI_ARGS}} --only-show-failed-tests
  lint:
    desc: run linters on Helm chart
    cmds:
      - helm lint {{.CLI_ARGS}}
      - helm template {{.CLI_ARGS}} | kubeval
  docs:
    desc: renders docs
    cmds:
      - helm-docs charts/
  test:
    desc: test helm chart
    cmds:
      - cd tests && go test ./...
  package:
    desc: package helm chart
    cmds:
      - cr package {{.CLI_ARGS}}
  upload:
    desc: upload packaged helm chart to github repository releases page
    cmds:
      - cr upload -o curuvija --git-repo helm-charts --package-path .cr-release-packages/ --token $GITHUB_TOKEN --release-notes-file CHANGELOG.md
  release:
    desc: release helm chart manually
    cmds:
      - task: lint
      - task: docs
      - task: test
      - task: package
      - task: upload
